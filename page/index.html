<!DOCTYPE html>
<html lang="js">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        canvas {
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -100;
        }

        #log {
            height: 90%;
            width: 20%;
            position: absolute;
            right: 10px;
        }

        .left {
            width: 20%;
        }
    </style>
</head>

<body>
    <canvas id="can"></canvas>
    <h1 id="title" class="left">OnlineOthello</h1>
    <h2 id="turn" class="left"></h2>
    <input value="username" id="username" class="remove">
    <h2 class="remove">build a room</h2>
    <input value="room name" id="name" class="remove">
    <input value="room pass" id="pass" class="remove">
    <input type="submit" id="buildroom" class="remove">
    <h2 class="remove">join a room</h2>
    <input value="room name" id="jr_rn" class="remove">
    <input value="room pass" id="jr_rp" class="remove">
    <input value="join room" id="jr_sb" class="remove" type="submit">

    <input type="hidden" id="roomid">
    <input type="hidden" id="vs">
    <input type="hidden" id="color">
    <textarea id="log" readonly></textarea>
    <script src="/socket.io/socket.io.js"></script>
    <script src="./frontOthelloClass.js" type="module"></script>
    <script type="module">
        const socket = io()
        let name, username, pass, color
        const setRoomId = (id) => document.getElementById("roomid").value = id
        const getRoomId = () => document.getElementById("roomid").value
        const setVs = (vs) => document.getElementById("vs").value = vs
        const getVs = () => document.getElementById("vs").value
        const setColor = (color) => document.getElementById("color").value = color
        const getColor = () => document.getElementById("color").value
        function log(str) {
            let now = new Date()
            document.getElementById("log").value += `${now.getHours().toString().padStart(2, 0)}:${now.getMinutes().toString().padStart(2, 0)}:` + str + "\n\n"
        }
        let inp_br = document.getElementById("buildroom")
        import { Othello } from "./frontOthelloClass.js"
        let size = Math.min(innerHeight, innerWidth) / 2
        let can = document.getElementById("can")
        can.height = size
        can.width = size
        if(innerHeight>=innerWidth){
            let loge=document.getElementById("log")
            loge.style.position="absolute"
            loge.style.height="20%"
            loge.style.width="100%"
            loge.style.bottom="0px"
            loge.style.left="10px"
            loge.style.right="10px"
        }else{
            document.getElementById("log").style.top="10px"
        }
        class OnlineOthello extends Othello {
            writeOn(canvasElement) {
                super.writeOn(canvasElement)
                this.clickEvent = (e) => {
                    if (!this.canPutAt(this.mouseX, this.mouseY, color).map(v => v[0]).includes(true)) {
                        log(`cannot put ${[null, "black", "white"][color]} at ${this.mouseX},${this.mouseY}`)
                        return
                    }
                    log(`you put ${[null, "black", "white"][color]} at ${this.mouseX},${this.mouseY}`)
                    socket.emit("put", getRoomId(), this.mouseX, this.mouseY)
                }
                return this
            }
        }
        let othello = new OnlineOthello().writeOn(can)
        window.addEventListener("resize", () => {
            size = Math.min(innerHeight, innerWidth) / 2
            can = document.getElementById("can")
            can.height = size
            can.width = size
            othello.writeOn(can).readHistry().drow()
        })
        console.log(othello)
        inp_br.addEventListener("click", () => {
            name = document.getElementById("name").value
            username = document.getElementById("username").value
            pass = document.getElementById("pass").value
            console.log(name, pass, username)
            if ([name, pass, username].some((v) => v === "")) return
            console.log("emit buildroom")
            socket.emit('buildroom', username, name, pass)
        })
        socket.on("buildroomFailure", (text) => {
            alert(text)
            log(text)
        })
        socket.on("buildroomSuccess", (text, roomid) => {
            document.getElementById("title").innerText = "OnlineOthello \nroom:" + name + "\nyou are black"
            color = 1
            setColor(1)
            log(text)
            setRoomId(roomid)
            console.log(roomid)
            let elms = document.getElementsByClassName("remove")
            let length = elms.length
            for (let i = 0; i < length; i++) {
                elms[0].remove()
            }
            othello.drow()
        })
        document.getElementById("jr_sb").addEventListener("click", () => {
            username = document.getElementById("username").value
            name = document.getElementById("jr_rn").value
            pass = document.getElementById("jr_rp").value
            if ([name, pass, username].some((v) => v === "")) return
            console.log("joinroom emit", username, name, pass)
            socket.emit("joinroom", username, name, pass)
        })
        socket.on("joinroomFailure", (text) => {
            alert(text)
            log(text)
        })
        socket.on("joinroomSuccess", (text, roomId, vs) => {
            document.getElementById("title").innerText = "OnlineOthello \nroom:" + name + "\nyou are white"
            setVs(vs)
            log(`you join ${vs}'s room`)
            color = 2
            setColor(2)
            console.log(text)
            setRoomId(roomId)
            let elms = document.getElementsByClassName("remove")
            let length = elms.length
            for (let i = 0; i < length; i++) {
                elms[0].remove()
            }
            othello.drow()
        })
        socket.on("joined", (vs) => {
            log(vs + " joined this room")
            setVs(vs)
        })
        let settle = false
        socket.on("start", () => {
            log("start")
            setInterval(() => {
                if (settle) return
                if (getColor() - 1 === othello.history.length % 2) {
                    othello.enableClickToPut()
                    document.getElementById("turn").innerText = "now is your turn"
                    return
                }
                document.getElementById("turn").innerText = "now is " + getVs() + "'s turn"
                othello.disableClickToPut()
            }, 100)
        })
        socket.on("put", (x, y) => {
            log(`${getVs()} put at ${x},${y}`)
        })
        socket.on("history", (history) => {
            othello.setHistory(history)
            console.log(othello.history)
            othello.readHistry().drow()
        })
        othello.winner.then((winner) => {
            othello.disableClickToPut()
            log(`winner is ${winner}`)
            document.getElementById("turn").innerText=`winner is ${winner}\nif you want to play again,please reload`
            socket.emit("end",getRoomId())
        })
    </script>
</body>
</html>